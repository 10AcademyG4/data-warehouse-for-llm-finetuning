import requests
from bs4 import BeautifulSoup
import re
from pymongo import MongoClient
from faust import App, Topic

from data_processing import clean_data

app = App('data_stream_processing')
# Define a Faust topic for message queuing
data_topic = Topic('scraped_data')


def scrape_website(url):
    response = requests.get(url)

    if response.status_code == 200:
        
        soup = BeautifulSoup(response.text, 'html.parser')
        data_elements = soup.find_all('p')
        for lines in data_elements:
            data_element = lines.get_text(strip=True)

        # Process and clean the data
        cleaned_data = [clean_data(element.text) for element in data_elements]

        return cleaned_data
    else:
        print("Failed to retrieve data from the website.")
        return None

# Function to store data in MongoDB
def store_in_mongodb(data):
    # Connect to MongoDB
    client = MongoClient('localhost', 27017)
    
    # Create or access the database
    db = client['web_data']
    
    # Create or access the collection
    collection = db['scraped_data']
    
    # Insert the data into the collection
    result = collection.insert_many([{'data': item} for item in data])
    
    print(f"{len(result.inserted_ids)} documents inserted into the MongoDB collection.")

# Stream processing using Faust
@app.agent(data_topic)
async def process_data(data_stream):
    async for data in data_stream:
        # Perform any processing or transformations on the data here
        processed_data = data.upper()  # Example: Convert data to uppercase
        
        # Store the processed data in MongoDB
        store_in_mongodb([processed_data])

if __name__ == "__main__":
    # URL of the website to scrape
    url = 'https://am.wikipedia.org/wiki/%E1%8B%93%E1%8D%84_%E1%89%B4%E1%8B%8E%E1%8B%B5%E1%88%AE%E1%88%B5'

    # Scrape data from the website
    scraped_data = scrape_website(url)

    if scraped_data:
        # Send the scraped data to the Faust topic for message queuing
        data_topic.send(value=scraped_data)

    # Execute the Faust application
    app.main()
